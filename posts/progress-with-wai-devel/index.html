<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
              rel="stylesheet"
              integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
              crossorigin="anonymous"
        >

        

        <link rel="stylesheet" href="https://njagi.me/style.css">

        <title>Mostly Programming</title>
    </head>

    <body>

        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="/">Home</a>

                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/posts/">Posts</a></li>
                    <li class="nav-item"><a class="nav-link" href="/notes/">Notes</a></li>
                    <li class="nav-item"><a class="nav-link" href="/wiki/">Wiki</a></li>
                    <li class="nav-item"><a class="nav-link" href="/tags/">Tags</a></li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li class="nav-item"><a class="nav-link" href="/about/">About</a></li>
                </ul>

            </div> <!-- container fluid -->
        </nav>

        <div class="container">
            <div class="margin-vertical-20">
                

<div class="row">
    <div class="row justify-content-end"> <!-- start post heading -->
        <div class="col-md-10">

            <h1 id="post-title">Progress with wai-devel</h1>

            <div id="post-metadata">
                August 13, 2015

                <p>
                    
                    Tags:
                    <span class="tags">
                        
                        <button type="button" class="btn btn-link btn-sm">
                            <a href="https://njagi.me/tags/programming/">Programming</a>
                        </button>
                        
                        <button type="button" class="btn btn-link btn-sm">
                            <a href="https://njagi.me/tags/haskell/">Haskell</a>
                        </button>
                        
                        <button type="button" class="btn btn-link btn-sm">
                            <a href="https://njagi.me/tags/wai/">WAI</a>
                        </button>
                        
                        <button type="button" class="btn btn-link btn-sm">
                            <a href="https://njagi.me/tags/wai-devel/">wai-devel</a>
                        </button>
                        
                    </span>
                    
                </p>

            </div> <!-- page metadata -->
        </div>
    </div> <!-- end post heading -->

    <div class="row justify-content-center">  <!-- start post content -->
        <div class="col-md-8">
            <p>wai-devel is a  development server for wai compliant haskell web applications.</p>
<p>Its name changed from yesod-devel (the haskell reddit community suggested this).
You can find it at: <a href="https://github.com/urbanslug/wai-devel">https://github.com/urbanslug/wai-devel</a></p>
<span id="continue-reading"></span><h2 id="what-wai-devel-expects-from-your-application">What wai-devel expects from your application</h2>
<p>Since wai-devel is very loosely coupled to your application it expects mainly two things from your application:
a <strong>host:port</strong> pair and a function, <strong>Application.develMain</strong>.</p>
<p>Due to it's dependence on ide-backend it also expects you to set the environment variable <code>GHC_PACKAGE_PATH</code>.</p>
<p>Mine for example is: <code>export GHC_PACKAGE_PATH=~/.stack/snapshots/x86_64-linux/lts-2.22/7.8.4/pkgdb:</code></p>
<p>The host:port pair is expected to be passed in as two environment variables:
wai_host and wai_port for example:</p>
<ul>
<li>export wai_host=127.0.0.1</li>
<li>export wai_port=3001</li>
</ul>
<p>Better yet, the application itself should set the environment variables as in the example code below.</p>
<p>wai-devel looks for a function Application.develMain
I have a <a href="https://github.com/urbanslug/yesod">fork of yesod</a>, that builds a yesod binary which
generates a scaffold with this function implemented.
I recommend using it to generate the scaffold with which to try out wai-devel with.</p>
<p>The specifics of how to set the port and host within yesod applications will obviously change.
The point of this fork is to generate a scaffold that works with wai-devel out of the box.</p>
<p>Here is a snippet develMain function from my yesod fork.</p>
<pre data-lang="haskell" style="background-color:#002b36;color:#839496;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span style="color:#586e75;">-- | main function for use by yesod devel
</span><span style="color:#b58900;">develMain </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span>develMain </span><span style="color:#859900;">=</span><span> develMainHelper&#39; getApplicationDev
</span><span>
</span><span style="color:#b58900;">develMainHelper&#39; </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO</span><span> (</span><span style="color:#268bd2;">Settings</span><span>, </span><span style="color:#268bd2;">Application</span><span>) </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span>develMainHelper&#39; getSettingsApp </span><span style="color:#859900;">= do
</span><span>    (settings, app) </span><span style="color:#859900;">&lt;-</span><span> getSettingsApp
</span><span>
</span><span>    _ </span><span style="color:#859900;">&lt;-</span><span> unsetEnv &quot;</span><span style="color:#2aa198;">wai_port</span><span>&quot; </span><span style="color:#859900;">&gt;&gt;</span><span> setEnv &quot;</span><span style="color:#2aa198;">wai_port</span><span>&quot; &quot;</span><span style="color:#2aa198;">3001</span><span>&quot;
</span><span>    _ </span><span style="color:#859900;">&lt;-</span><span> unsetEnv &quot;</span><span style="color:#2aa198;">wai_host</span><span>&quot; </span><span style="color:#859900;">&gt;&gt;</span><span> setEnv &quot;</span><span style="color:#2aa198;">wai_host</span><span>&quot; &quot;</span><span style="color:#2aa198;">127.0.0.1</span><span>&quot;
</span><span>
</span><span>    </span><span style="color:#859900;">let</span><span> settings&#39;  </span><span style="color:#859900;">=</span><span> setPort (</span><span style="color:#6c71c4;">3001 </span><span style="color:#859900;">:: </span><span style="color:#cb4b16;">Port</span><span>) settings
</span><span>        settings&#39;&#39; </span><span style="color:#859900;">=</span><span> setHost ((read &quot;</span><span style="color:#2aa198;">127.0.0.1</span><span>&quot;) </span><span style="color:#859900;">:: </span><span style="color:#cb4b16;">HostPreference</span><span>) settings</span><span style="color:#859900;">\</span><span>&#39;
</span><span>
</span><span>    sock </span><span style="color:#859900;">&lt;-</span><span> createSocket
</span><span>
</span><span>    runSettingsSocket settings&#39;&#39; sock app
</span><span>
</span><span>    </span><span style="color:#859900;">where </span><span style="color:#586e75;">-- | Create the socket that we will use to communicate with
</span><span>          </span><span style="color:#586e75;">-- localhost:3001 here.
</span><span>          </span><span style="color:#b58900;">createSocket </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO Socket
</span><span>          createSocket </span><span style="color:#859900;">= do
</span><span>
</span><span>            sock </span><span style="color:#859900;">&lt;-</span><span> socket </span><span style="color:#cb4b16;">AF_INET Stream</span><span> defaultProtocol
</span><span>
</span><span>            </span><span style="color:#586e75;">-- Tell the OS *not* to reserve the socket after your program exits.
</span><span>            setSocketOption sock </span><span style="color:#cb4b16;">ReuseAddr </span><span style="color:#6c71c4;">1
</span><span>
</span><span>            </span><span style="color:#586e75;">-- Bind the socket to localhost:3000 and listen.
</span><span>            </span><span style="color:#586e75;">-- I wonder why I can&#39;t specify localhost instead of iNADDR_ANY
</span><span>            bindSocket sock (</span><span style="color:#cb4b16;">SockAddrInet </span><span style="color:#6c71c4;">3001</span><span> iNADDR_ANY)
</span><span>            listen sock </span><span style="color:#6c71c4;">2
</span><span>            return sock
</span></code></pre>
<blockquote>
<p>During socket creation I made sure that the socket option ReuseAddr has been set to 1.<br />
This way the operating system doesn't hold on to the socket after the program exits.
This is important for when wai-devel takes note of file changes and the development server is restarted.</p>
</blockquote>
<h2 id="ignoring-files-and-directories">Ignoring files and directories</h2>
<p>wai-devel expects that there will be a single <code>Main.main</code> function.
In the case of having more than one, for example with yesod, we ignore all but one.
Specifically, we ignore the file app/DevelMain.hs.
There is no need for app/devel.hs so it has been removed in my fork.</p>
<p>Moreover, wai-devel ignores files in your <code>test/</code> directory.<br />
This is because wai-devel depends on ide-backend which will attempt to build all files in the current working diretory,
including your test directory. This leads to a world of hurt because the test/ directory also has a <code>Main.main</code> function.</p>
<p><em>Please report an issue if you would like any file ignored during builds.</em></p>
<h1 id="moved-to-stack">Moved to stack</h1>
<p>Since the Haskell community has moved in this direction, so has wai-devel.<br />
wai-devel only depends on cabal in that stack and ide-backend depend on Cabal the library.
Otherwise, the cabal binary is not used and hasn't been tested to work with wai-devel.</p>
<h2 id="compatible-versions-of-ghc">Compatible versions of GHC</h2>
<p>Currently wai-devel is built and tested against:</p>
<ul>
<li>GHC-7.8</li>
<li>GHC-7.10</li>
</ul>
<h2 id="regarding-file-watching">Regarding file watching</h2>
<p>wai-devel watches for file changes on files with the following extensions:</p>
<ul>
<li>hamlet</li>
<li>shamlet</li>
<li>julius</li>
<li>lucius</li>
<li>hs</li>
<li>yaml</li>
</ul>
<p>When a change takes place wai-devel will recompile and re-run your application
on localhost:3001 or display an error if any on the browser at localhost:3000</p>
<p><em>If you would want another extension added to the list of file extensions to watch for please report it as an issue.</em></p>
<h2 id="command-line-arguments">Command line arguments</h2>
<p>Currently wai-devel takes only these two arguments and the two are optional.
If you feel the need for more arguments please report it as an issue on github.</p>
<ul>
<li>
<p>-r <em>to turn off reverse proxying</em>
If this is turned on you will access your application at an address that is specific to
your web application or web framework.</p>
</li>
<li>
<p>--show-iface [hi file] <em>passes this command to ghc</em>
Same as ghc --show-iface</p>
</li>
</ul>

        </div>
    </div>  <!-- end post content -->

</div> <!--  -->



            </div>
        </div>

    </body>

    <footer>
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-6">
                    <p class="p-copyright">
                        All work is under the <a href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License, Version 1.3</a>.
                    </p>
                </div>
            </div>
        </div>
    </footer>

</html>
