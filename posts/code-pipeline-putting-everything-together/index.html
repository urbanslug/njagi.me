<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
              rel="stylesheet"
              integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
              crossorigin="anonymous"
        >

        

        <link rel="stylesheet" href="https://njagi.me/style.css">

        <title>Mostly Programming</title>
    </head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="/">Home</a>

                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/posts/">Posts</a></li>
                    <li class="nav-item"><a class="nav-link" href="/notes/">Notes</a></li>
                    <li class="nav-item"><a class="nav-link" href="/wiki/">Wiki</a></li>
                    <li class="nav-item"><a class="nav-link" href="/tags/">Tags</a></li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li class="nav-item"><a class="nav-link" href="/about/">About</a></li>
                </ul>

            </div> <!-- container -->
        </nav> <!-- end nav -->

        <div class="container">
            <div class="margin-vertical-20">
                

<div class="row">
    <div class="row justify-content-end"> <!-- start post heading -->
        <div class="col-md-10">

            <h1 id="post-title">Pipeline as Code—Putting Everything Together</h1>

            <div id="post-metadata">
                October 16, 2017

                <p>
                    
                    Tags:
                    <span class="tags">
                        
                        <button type="button" class="btn btn-link btn-sm">
                            <a href="https://njagi.me/tags/devops/">Devops</a>
                        </button>
                        
                        <button type="button" class="btn btn-link btn-sm">
                            <a href="https://njagi.me/tags/ci/">CI</a>
                        </button>
                        
                        <button type="button" class="btn btn-link btn-sm">
                            <a href="https://njagi.me/tags/cd/">CD</a>
                        </button>
                        
                    </span>
                    
                </p>

            </div> <!-- page metadata -->
        </div>
    </div> <!-- end post heading -->

    <div class="row justify-content-center">  <!-- start post content -->
        <div class="col-md-8">
            <p>In this post we shall implement a continuous deployment pipeline using
<a href="https://www.ansible.com/">ansible</a>, <a href="https://travis-ci.org/">travis ci</a> and <a href="https://git-scm.com/">git</a>.</p>
<p>During implementation we don't have steps such as planning, provisioning,
configuration management etc that we mentioned in the <a href="/posts/2017-10-13-code-pipeline-overview.html">previous post</a>; those are
conceptual. The flowchart below represents the actual places that our software
should live at all times. Think of each component in the flowchart as a service
that exposes an API.</p>
<span id="continue-reading"></span>
<p><img src="/images/Content/Flowcharts/Pipeline_as_code_putting.svg" alt="" /></p>
<h2 id="deploy-server">Deploy server</h2>
<p>In the diagram above we introduce an deploy server. This is the
host from which you can access your other servers such production, staging etsc.</p>
<blockquote>
<p>Exposes: ansible, ssh</p>
</blockquote>
<h2 id="git-version-control">Git (Version Control)</h2>
<p>We want to have playbooks, deploy scripts and code in version control.<br />
What we get from version control that is necessary for continuous deployment is:</p>
<ul>
<li>tags get deployed to the main production environment</li>
<li>master branch gets deployed to the main staging environment</li>
<li>other major branches get deployed to other staging environments of our
choosing</li>
</ul>
<p>Not all these steps need to be done for it to be a continuous deployment
pipeline. For example: for this blog, changes that get merged into master go
straight into production. This is because the application is really small and
simple so before anything goes into master I know it's error free.
Moreover, even if the blog were to experience downtime I have very little to
lose compared to a business. This is the same model that github pages uses;
what is in master is pushed into the <code>gh-pages</code> branch which is basically a
github pages blog's production environment.</p>
<blockquote>
<p>Exposes: git branches and git tags</p>
</blockquote>
<h2 id="ansible-provisioning-and-configuration-management">Ansible (Provisioning and Configuration Management)</h2>
<p>Assuming you have a fresh server such as the one Digital Ocean would offer
or a fresh EC2 instance. We want an ansible play that creates an unprivileged
user with SSH authentication.
So we have to do the following locally or on our deploy server:</p>
<ul>
<li>generate an SSH key pair <strong>without a passphrase</strong></li>
<li>add the public key of the generated key to the deploy user's known_hosts file</li>
<li>push the private key of the generated key to travis ci so that the travis
container can autheniticate as that user.</li>
</ul>
<h3 id="generate-an-ssh-keypair-without-a-passphrase">Generate an SSH keypair without a passphrase</h3>
<p>Under <code>Enter file in which to save the key...</code> type in <code>travis-ci</code>.<br />
Under <code>Enter passphrase (empty for no passphrase):</code> just press enter</p>
<pre style="background-color:#002b36;color:#839496;"><code><span>$ ssh-keygen -t ed25519 -C &quot;travis@travis-ci.org&quot;
</span></code></pre>
<p>This will create two files <code>travis-ci</code> and <code>travis-ci.pub</code>.</p>
<h3 id="add-the-public-key-to-the-deploy-user-s-known-hosts">Add the public key to the deploy user's known_hosts</h3>
<p>Write a play to prepare the deploy environment.<br />
Copy the contents of <code>travis-ci.pub</code> file to a vars file in your the playbooks
For example <a href="https://github.com/urbanslug/playbooks/blob/master/roles/base/vars/vars.yml#L1">here's my vars file</a>.</p>
<pre data-lang="yml" style="background-color:#002b36;color:#839496;" class="language-yml "><code class="language-yml" data-lang="yml"><span style="color:#268bd2;">travis_ci_pubkey</span><span>: &quot;</span><span style="color:#2aa198;">ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINFzeaPrMXDVS1/+V4hKsgC+Pzoa9tnGGP+VCPT21QXP travis@travis-ci.org</span><span>&quot;
</span></code></pre>
<p>Add a section in a play of your choosing that copies the public key to the
deploy user's known_hosts.</p>
<pre data-lang="yml" style="background-color:#002b36;color:#839496;" class="language-yml "><code class="language-yml" data-lang="yml"><span>- </span><span style="color:#268bd2;">include_vars</span><span>: </span><span style="color:#2aa198;">vars.yml
</span><span>
</span><span>- </span><span style="color:#268bd2;">name</span><span>: </span><span style="color:#2aa198;">Create deploy user
</span><span>  </span><span style="color:#268bd2;">user</span><span>: </span><span style="color:#2aa198;">name=deploy
</span><span>        </span><span style="color:#2aa198;">group=www
</span><span>
</span><span>- </span><span style="color:#268bd2;">name</span><span>: </span><span style="color:#2aa198;">copy travis-ci public ssh key to deploy user
</span><span>  </span><span style="color:#268bd2;">authorized_key</span><span>: </span><span style="color:#2aa198;">key=&quot;{{ travis_ci_pubkey }}&quot;
</span><span>                  </span><span style="color:#2aa198;">path=/home/deploy/.ssh/authorized_keys
</span><span>                  </span><span style="color:#2aa198;">user=deploy
</span></code></pre>
<p>This creates the deploy user and adds the travis-ci.pub
to the deploy user's <code>~/.ssh/known_hosts</code>.</p>
<h3 id="make-your-target-a-git-server">Make your target a git server</h3>
<p>For commands like <code>git push</code> to work from travis-ci to your deploy user
you have to have your server be ready to receive git push commands.
I will explain this later in a different post but for now what you need is a
play that:</p>
<ul>
<li>Installs git</li>
<li>Creates a target git repo which we shall push to</li>
<li>Is able to overwrite the current contents of the repo when a change occurs.</li>
</ul>
<pre data-lang="yaml" style="background-color:#002b36;color:#839496;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#586e75;"># creates a blog.git dir which is a bare git repo
</span><span>- </span><span style="color:#268bd2;">name</span><span>:    </span><span style="color:#2aa198;">Create a bare blog.git repo
</span><span>  </span><span style="color:#268bd2;">command</span><span>: &quot;</span><span style="color:#2aa198;">git init --bare blog.git</span><span>&quot;
</span><span>
</span><span>- </span><span style="color:#268bd2;">name</span><span>: </span><span style="color:#2aa198;">Add a post-receive hook to update blog
</span><span>  </span><span style="color:#268bd2;">copy</span><span>: </span><span style="color:#2aa198;">src=../files/git/hooks/post-receive
</span><span>        </span><span style="color:#2aa198;">dest=blog.git/hooks/post-receive
</span><span>        </span><span style="color:#2aa198;">owner=deploy
</span><span>        </span><span style="color:#2aa198;">group=www
</span><span>        </span><span style="color:#2aa198;">mode=0550
</span><span>        </span><span style="color:#2aa198;">backup=yes
</span></code></pre>
<pre data-lang="bash" style="background-color:#002b36;color:#839496;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#586e75;">#! /bin/bash
</span><span>
</span><span style="color:#586e75;"># post-recieve hook to handle updates
</span><span style="color:#586e75;"># delete the current blog
</span><span style="color:#b58900;">rm</span><span style="color:#268bd2;"> -rf </span><span style="color:#d33682;">~</span><span>/blog
</span><span style="color:#859900;">cd </span><span style="color:#d33682;">~</span><span>/
</span><span style="color:#586e75;"># clone from the blog.git bare repo into a blog dir
</span><span style="color:#b58900;">git</span><span> clone blog.git blog
</span></code></pre>
<p>If you take notice this is similar to the bare git repo that github provides.
For example: to clone this blog from github via ssh we would run:</p>
<pre data-lang="bash" style="background-color:#002b36;color:#839496;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#b58900;">$</span><span> git clone git@github.com:urbanslug/blog.git
</span></code></pre>
<p>and if you had ssh access to the server hosting this blog you would run:</p>
<pre data-lang="bash" style="background-color:#002b36;color:#839496;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#b58900;">$</span><span> git clone deploy@git.urbanslug.com:blog.git
</span></code></pre>
<p>I hope you can draw some interesting parallels there.
Here's my <a href="https://github.com/urbanslug/playbooks/blob/master/roles/blog/tasks/main.yml">blog's play</a> for reference.</p>
<p>In the case of this blog I run the below command from my deploy server.</p>
<pre data-lang="bash" style="background-color:#002b36;color:#839496;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#b58900;">$</span><span> ansible-playbook base.yml</span><span style="color:#268bd2;"> --ask-sudo-pass --ask-vault-pass
</span></code></pre>
<h3 id="push-the-private-key-to-travis-ci">Push the private key to travis ci</h3>
<p>Install the <a href="https://docs.travis-ci.com/user/encryption-keys/#Usage">travis cli tool</a></p>
<pre data-lang="bash" style="background-color:#002b36;color:#839496;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#b58900;">$</span><span> gem install travis
</span></code></pre>
<p>Encrypt your private key and add the decryption command to your .travis.yml file
using the travis cli tool and also push your public key to travis-ci with:</p>
<pre data-lang="bash" style="background-color:#002b36;color:#839496;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#b58900;">$</span><span> travis encrypt-file travis-ci</span><span style="color:#268bd2;"> --add
</span></code></pre>
<p>The <code>--add</code> flag  should add a  <code>before_install</code> phase to your .travis.yml file
that resembles the following:</p>
<pre data-lang="yml" style="background-color:#002b36;color:#839496;" class="language-yml "><code class="language-yml" data-lang="yml"><span style="color:#268bd2;">before_install</span><span>:
</span><span> - </span><span style="color:#2aa198;">openssl aes-256-cbc -K $encrypted_7f9f7befb56d_key -iv $encrypted_7f9f7befb56d_iv -in travis-ci.enc -out travis-ci -d
</span></code></pre>
<p>That line decrypts your travis-ci private key in the travis container at runtime
and creates a <code>~/travis-ci</code> which is the private key. Make sure not to have
multiple before-install phases.</p>
<blockquote>
<p>Exposes: travis encrypt-file, ssh-keygen, ansible-playbook, ansible vars</p>
</blockquote>
<h2 id="travis-ci-continuous-integration-and-continuous-deployment">Travis CI (Continuous Integration and Continuous Deployment)</h2>
<p>Travis CI is a mix of open source and some proprietary tools.<br />
To quote them &quot;Travis CI is run as a hosted service, free for Open Source, a
paid product for private code, and it’s available as an on-premises version
(Travis CI Enterprise).&quot;</p>
<p>Here's their <a href="https://github.com/travis-ci">github page</a> and
<a href="https://github.com/travis-ci/travis-ci">info page</a>.
To learn how to get started with travis in your project you can read
<a href="https://docs.travis-ci.com/user/getting-started/">get started doc</a>.
Moving on, I assume you have (gained) enough experience with travis to go on.</p>
<p>Travis will run tests and/or build our application on every branch or
specific branches based on rules that we set. We then build on this
functionality to deploy to a target based on various
rules. The obvious one being when our tests pass.</p>
<p>In our case: we want to run tests then after that deploy to the relevant target.
In your .travis.yml file you can use one of the following
<a href="https://docs.travis-ci.com/user/customizing-the-build/#The-Build-Lifecycle">travis ci build phases</a> <code>after_success</code> or <code>deploy</code> steps.
I prefer to use <code>after_success</code> when I want to run a deploy script and then list
all the commands that my script would run and <code>deploy</code> for already supported
deploy environments.
This is because the script feature is experimental at the time of writing this.</p>
<blockquote>
<p>Exposes: .travis.yml</p>
</blockquote>
<h3 id="continuously-deploying-to-a-host">Continuously deploying to a host</h3>
<p>We want to push code from our travis container to our server.
Here are some essesntials that would guide you in creating a .travis.yml file
that would deploy to your target.</p>
<h3 id="using-after-success">Using after_success</h3>
<p>The <code>branches</code> section is essential in this case because it ensures that the
.travis.yml file will only be ran for the master branch.</p>
<pre data-lang="yaml" style="background-color:#002b36;color:#839496;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#268bd2;">branches</span><span>:
</span><span>  </span><span style="color:#268bd2;">only</span><span>:
</span><span>    - </span><span style="color:#2aa198;">master
</span><span>
</span><span style="color:#268bd2;">addons</span><span>:
</span><span>  </span><span style="color:#586e75;"># add the target server to the containers known_hosts
</span><span>  </span><span style="color:#586e75;"># this prevents a blocking prompt to add the server to travis-ci&#39;s
</span><span>  </span><span style="color:#586e75;"># known_hosts when attempting to git push
</span><span>  </span><span style="color:#268bd2;">ssh_known_hosts</span><span>:
</span><span>    - </span><span style="color:#2aa198;">git.urbanslug.com
</span><span>
</span><span style="color:#586e75;"># decrypt our public key
</span><span style="color:#268bd2;">before_install</span><span>:
</span><span>  - </span><span style="color:#2aa198;">openssl aes-256-cbc -K $encrypted_7f9f7befb56d_key -iv $encrypted_7f9f7befb56d_iv -in travis-ci.enc -out travis-ci -d
</span><span>
</span><span style="color:#268bd2;">env</span><span>:
</span><span>  </span><span style="color:#268bd2;">global</span><span>:
</span><span>    - </span><span style="color:#268bd2;">GIT_EMAIL</span><span>: </span><span style="color:#2aa198;">travis@travis-ci.org
</span><span>    - </span><span style="color:#268bd2;">GIT_NAME</span><span>: </span><span style="color:#2aa198;">Travis CI
</span><span>
</span><span>
</span><span style="color:#268bd2;">script</span><span>:
</span><span>  - </span><span style="color:#2aa198;">./site.hs build
</span><span>
</span><span style="color:#586e75;"># run the following commends after the script phase is successful
</span><span style="color:#268bd2;">after_success</span><span>:
</span><span>  - </span><span style="color:#2aa198;">eval &quot;$(ssh-agent -s)&quot; </span><span style="color:#586e75;"># start the ssh agent
</span><span>  - </span><span style="color:#2aa198;">chmod 600 travis-ci
</span><span>  - </span><span style="color:#2aa198;">ssh-add  travis-ci </span><span style="color:#586e75;"># add travis-ci private key to the ssh agent
</span><span>  - </span><span style="color:#2aa198;">cd _site
</span><span>  - </span><span style="color:#2aa198;">git init
</span><span>  - </span><span style="color:#2aa198;">git config --global user.email &quot;$GIT_EMAIL&quot;
</span><span>  - </span><span style="color:#2aa198;">git config --global user.name  &quot;$GIT_NAME&quot;
</span><span>  - </span><span style="color:#2aa198;">git remote add deploy &quot;deploy@git.urbanslug.com:blog.git&quot;
</span><span>  - </span><span style="color:#2aa198;">git add --all
</span><span>  - </span><span style="color:#2aa198;">git status
</span><span>  - </span><span style="color:#2aa198;">git commit -m &quot;Built by Travis ( build $TRAVIS_BUILD_NUMBER )&quot;
</span><span>  - </span><span style="color:#2aa198;">git push -q --force deploy master:master
</span></code></pre>
<h3 id="github-pages">Github pages</h3>
<p>Here's the way <a href="https://github.com/goodbotai/borq">borq, a library from goodbot.ai,</a> has its docs deployed to
github pages every time a tag is created and here's the
<a href="https://github.com/goodbotai/borq/blob/master/.travis.yml">complete travis.yml file for borq</a>.</p>
<p>In the above case <code>travis-encrypt</code> is used to encrypt the github token like so</p>
<pre data-lang="bash" style="background-color:#002b36;color:#839496;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#b58900;">$</span><span> travis encrypt GH_TOKEN=super_secret_token</span><span style="color:#268bd2;"> --add
</span></code></pre>
<p>The essentials of our .travis.yml file</p>
<pre data-lang="yaml" style="background-color:#002b36;color:#839496;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#268bd2;">env</span><span>:
</span><span>  </span><span style="color:#268bd2;">global</span><span>:
</span><span>    - </span><span style="color:#268bd2;">GH_REF</span><span>: </span><span style="color:#2aa198;">github.com/goodbotai/borq.git
</span><span>    - </span><span style="color:#268bd2;">secure</span><span>: </span><span style="color:#2aa198;">S567U/zOMKOddrGtQBmFyA6ROzinMgheQ7rGoyVbw9i43hBzvKVgk+C77+cVCLPr8ps6qwqhV9Ex5ehM3ic9gXDJt9ZlpzlevP+epKxG11WL3S3RwAOGlp/wOkSM+KhEqYqNOSzjA5WLttzg5GFSqs+T3l7HelQfZk55t2O4HSmmKUKPbFfDZ/84suvPSf1pm+d8f99k5KQFnTO3JHbIkbdx76Hsa8KRsZFJ2oA3DgQOXPOf+W3AdlG5zT5t1hAv0wg1O1Q45zB1MDcMfAUYcJOk72eajWTx9E0jreAgEVNUG2oyBG+GNdN2eMtbO4hANcdbBAH6wQq797OK76YVN6MM2HiMMZ1W7emNmo5wP6nc23w7YXJ88a1Ysffxxi4aLOMD1rBlVT5/cjcjvRUeR/OHx+9fOLPo/G6KioC5oz0iXwNPSYkZBHQ3nKf4uribXAPV/8f+n9HzjSQTnILWXiYaaGqIJAjEzL8WL5dBBGhngkILzCX/Ur4LeYJkhLnrVTg089X8urjtWnBpZKMKAwhPfV768prfKurmRbirIlgJfw5WfRoiV34Bl3O7bcNQMQ0nIobgaNhF8JZRq6adp0K8ChVnfNl3oplXN1kiVr9YJRRb4ErLzRSJZqkP/TNUqOs5wFeiSoFGgCUvAyjQZN5IkKIr4VrdKcnbEgj/3Co=
</span><span>
</span><span style="color:#268bd2;">deploy</span><span>:
</span><span>  </span><span style="color:#268bd2;">skip_cleanup</span><span>: </span><span style="color:#b58900;">true
</span><span>  </span><span style="color:#268bd2;">provider</span><span>: </span><span style="color:#2aa198;">pages
</span><span>  </span><span style="color:#268bd2;">local_dir</span><span>: </span><span style="color:#2aa198;">out
</span><span>  </span><span style="color:#268bd2;">github_token</span><span>: </span><span style="color:#2aa198;">$GH_TOKEN
</span><span>  </span><span style="color:#b58900;">on</span><span>:
</span><span>    </span><span style="color:#268bd2;">tags</span><span>: </span><span style="color:#b58900;">true
</span></code></pre>
<p>I just explained how we can set up a project so that the CI tool handles all
deploys going forward after the inital setting up. If anything goes wrong we can
go into the deploy server and then run an ansible script and have it roll back
to a specific tag/branch.</p>
<p>In the next post we shall talk about continuous deployment in a microservice
architechture using the same tools but deploying to AWS ECS.</p>

        </div>
    </div>  <!-- end post content -->

</div> <!--  -->



            </div>
        </div>
    </body>
</html>
